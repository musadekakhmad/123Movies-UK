<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>123Movies UK</title>
    <!-- Favicon: Using SVG emoji for the movie icon. More concise and no external files needed. -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🎬</text></svg>">

    <!-- Description and Keywords for SEO -->
    <meta name="description" content="123Movies UK: Stream thousands of free movies and TV series online in HD quality. Discover the latest blockbusters, classic films, and popular TV shows with no subscription required. Your ultimate destination for unlimited entertainment, available on any device. Start watching now!">
    <meta name="keywords" content="123Movies UK, free movies, watch movies online, free TV series, stream TV shows, HD streaming, latest movies, popular TV series, no subscription, free entertainment, online cinema, movie streaming site, TV show streaming, watch films, full HD movies, free streaming platform, best free movies, watch series online, online entertainment, movie database, TV show database">

    <!-- Open Graph Meta Tags for Facebook, WhatsApp, etc. -->
    <meta property="og:title" content="123Movies UK">
    <meta property="og:description" content="123Movies UK: Stream thousands of free movies and TV series online in HD quality. Discover the latest blockbusters, classic films, and popular TV shows with no subscription required. Your ultimate destination for unlimited entertainment, available on any device. Start watching now!">
    <meta property="og:image" content="https://live.staticflickr.com/65535/54681957653_d6819848ed_b.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="https://123movies-uk.pages.dev/">
    <meta property="og:type" content="website">
    <meta property="fb:app_id" content="61577842845885">

    <!-- Canonical Tag for SEO -->
    <link rel="canonical" href="https://123movies-uk.pages.dev/">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Roboto -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for social icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* CSS to ensure the custom header is fixed */
        html, body {
            height: 100%; /* Important for fixed positioning */
            min-height: 100vh; /* Fallback and ensures full viewport height */
            overflow-x: hidden; /* Prevents horizontal scrolling */
            margin: 0; /* Removes default margin */
            padding: 0; /* Removes default padding */
            background-color: #1a202c; /* Ensures background color matches custom theme */
            display: flex; /* Uses flexbox for the body */
            flex-direction: column; /* Arranges flex items in a column */
            align-items: center; /* Centers items horizontally */
            font-family: 'Roboto', sans-serif; /* Uses Roboto font */
        }
        
        /* Ensures the custom header remains fixed and sets its internal layout */
        header {
            position: sticky; /* Sticky is generally better than fixed for headers */
            top: 0;
            left: 0;
            right: 0;
            width: 100%; /* Updated: Full width */
            z-index: 50; /* Ensures it's above other content */
            background-color: #1a202c; /* Ensures header has a dark background */
            box-sizing: border-box; /* Ensures padding doesn't increase width */
            padding-bottom: 0.5rem; /* Reduced from 1.25rem to 0.5rem */
            padding-top: 1.25rem;
        }

        /* Styles for the top part of the header container (logo, navigation, search) */
        /* Removed custom CSS for .header-top-row to rely on Tailwind classes */

        /* Styles for the genre buttons container (now part of the header) */
        .genre-buttons-container { /* Uses existing class, not fixed/top */
            width: 100%;
            background-color: #1a202c; /* Matches main header background color */
            /* Removed padding: 1rem; to rely on Tailwind classes */
            border-top: 1px solid rgba(255, 255, 255, 0.1); /* Visual separation line */
        }
        /* Ensures main content starts right after the header */
        main {
            margin-top: 0;
            padding-top: 0.5rem; /* Reduced from 1rem to 0.5rem for tighter spacing */
            width: 100%; /* Updated: Full width */
            margin-left: auto; /* Centers main content */
            margin-right: auto; /* Centers main content */
        }

        /* Adjust font size and padding for nav button to match genre button */
        .nav-button {
            font-size: 0.875rem; /* text-sm */
            padding-left: 1rem; /* px-4 */
            padding-right: 1rem; /* px-4 */
            padding-top: 0.5rem; /* py-2 */
            padding-bottom: 0.5rem; /* py-2 */
        }
        /* Adjust font size for medium and up screens to remain large like genre button */
        @media (min-width: 768px) {
            .nav-button {
                font-size: 1rem; /* md:text-base */
            }
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748; /* bg-gray-800 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568; /* bg-gray-600 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }

        /* Hide elements by default for layers */
        .layer-2, .layer-3, .layer-4 { /* Added .layer-4 */
            display: none;
        }

        /* Ensures iframe fills its container responsively */
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            border-radius: 0.5rem; /* rounded-lg */
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

        /* Basic spinner for loading */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #f97316; /* Orange-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Rainbow text style */
        .rainbow-text {
            background-image: linear-gradient(to right, violet, indigo, blue, green, yellow, orange, red);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent; /* Makes text color transparent for gradient to show */
            display: inline-block; /* Important for background-clip to work correctly */
            font-size: 56px; /* Changed from 52px to 56px */
        }

        /* FIX: Ensures detail title is visible */
        #detail-title {
            display: block;
            visibility: visible;
            height: auto;
            font-size: 3rem; /* Increased from 2.25rem (text-4xl) to 3rem (text-5xl) */
            line-height: normal;
            margin: 0 0 0.5rem 0; /* Adjust margin as needed */
        }

        /* Style for static movie cards in Layer 3 */
        .static-movie-card {
            background-color: #1f2937; /* bg-gray-800 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            overflow: hidden;
            transform: scale(1);
            transition: all 0.3s ease-in-out; /* transition-all duration-300 */
            cursor: pointer;
        }

        .static-movie-card:hover {
            transform: scale(1.05); /* hover:scale-105 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* hover:shadow-xl */
        }

        .static-movie-card img {
            width: 100%;
            height: auto;
            object-fit: cover;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }

        .static-movie-card .info {
            padding: 1rem; /* p-4 */
            text-align: center; /* Changed to center */
        }

        .static-movie-card h3 {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            color: #f9fafb; /* text-gray-100 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.25rem;
        }

        .static-movie-card p {
            font-size: 0.875rem; /* text-sm */
            color: #9ca3af; /* text-gray-400 */
        }

        /* CSS to remove underline from home logo link */
        #home-logo-link {
            text-decoration: none; /* Removes default underline */
        }
        #home-logo-link:hover {
            text-decoration: none; /* Ensures no underline on hover */
        }

        /* Styling for Layer 4 SEO content */
        .layer-4 { /* Target the section, not the inner content div */
            background-color: #1f2937; /* bg-gray-800 */
            padding: 2rem; /* p-8, or adjust as needed */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            color: #e2e8f0; /* text-gray-200 */
            line-height: 1.6;
            position: relative; /* Ensure absolute positioning of back button works */
            width: 100%; /* Ensure it takes full width of its parent (main) */
        }

        .layer-4-content { /* This is the inner div for the text */
            /* Removed max-width and margin: auto to allow it to expand within the section's padding */
        }

        .layer-4-content h1, .layer-4-content h2, .layer-4-content h3 {
            color: #f9fafb; /* text-gray-100 */
            font-weight: 700; /* font-bold */
            margin-bottom: 1rem;
        }

        .layer-4-content h1 {
            font-size: 2.5rem; /* text-4xl */
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .layer-4-content h2 {
            font-size: 2rem; /* text-3xl */
            margin-top: 2rem;
        }

        .layer-4-content h3 {
            font-size: 1.5rem; /* text-2xl */
            margin-top: 1.5rem;
        }

        .layer-4-content p {
            margin-bottom: 1rem;
            text-align: justify; /* Added for justified text */
        }

        .layer-4-content ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .layer-4-content ol {
            list-style-type: decimal;
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .layer-4-content li {
            margin-bottom: 0.5rem;
        }

        .layer-4-content strong {
            color: #cbd5e1; /* text-gray-300 */
        }

        .layer-4-content img {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            margin: 1.5rem auto;
            display: block;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen flex flex-col">

    <!-- Header (Fixed) - Now integrated with genre buttons -->
    <header class="sticky top-0 z-50 bg-gray-900 shadow-lg px-4 md:px-8 flex flex-col items-center rounded-b-lg">
        <!-- Header Top Part: Logo, Navigation and Search -->
        <div class="flex flex-col sm:flex-row items-center justify-between w-full py-4">
            <div class="flex items-center mb-4 sm:mb-0">
                <!-- Logo (simple text) - Now wrapped in an anchor tag to act as a Home button -->
                <a href="https://123movies-uk.pages.dev/" id="home-logo-link" class="inline-flex items-center text-indigo-500 hover:text-indigo-400 transition-colors duration-200" aria-label="Go to Home Page">
                <span class="text-3xl font-bold mr-2">🎬</span>
                <h1 class="text-5xl font-bold whitespace-nowrap rainbow-text">123Movies UK</h1>
                </a>
            </div>
            <nav class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-6 w-full sm:w-auto">
                <div class="flex w-full sm:w-auto sm:space-x-6">
                    <!-- New Home Button -->
                    <button id="nav-home-button" class="nav-button bg-gray-800 hover:bg-green-600 rounded-md text-gray-100 font-medium w-full sm:w-auto text-sm md:text-base transition-all duration-200" aria-label="Navigate to Home">Home</button>
                    <button id="nav-movies-button" class="nav-button bg-gray-800 hover:bg-blue-600 rounded-md text-gray-100 font-medium w-full sm:w-auto text-sm md:text-base transition-all duration-200" aria-label="Show Movies">Movies</button>
                    <button id="nav-tvseries-button" class="nav-button bg-gray-800 hover:bg-rose-600 rounded-md text-gray-100 font-medium w-full sm:w-auto text-sm md:text-base transition-all duration-200" aria-label="Show TV Series">TV Series</button>
                </div>
                <div class="relative w-full sm:w-64">
                    <input type="text" id="search-input" placeholder="Search movies..." class="w-full bg-gray-700 text-gray-200 placeholder-gray-400 py-2 pl-4 pr-10 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200" aria-label="Search movies or TV series">
                    <button id="search-button" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-200 transition-colors duration-200" aria-label="Perform search">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </button>
                </div>
            </nav>
        </div>
        <!-- Genre Filter Buttons - Dynamically loaded -->
        <div id="genre-buttons-container" class="genre-buttons-container hidden flex justify-center gap-0 py-2 overflow-x-auto whitespace-nowrap">
            <!-- Genre buttons will be loaded here by JS -->
        </div>
    </header>

    <main class="flex-grow px-4 pt-4 pb-12 max-w-[1344px] mx-auto">
        <!-- Layer 1: Movie/TV Thumbnails -->
        <section id="layer-1" class="layer-1">
            <!-- Upcoming Movies Section -->
            <div id="upcoming-movies-section" class="mb-6">
                <h2 class="text-3xl font-bold text-gray-100 mb-8 text-center"><span id="section-title-upcoming-movies">Upcoming Movies</span></h2>
                <div id="movie-grid-upcoming-movies" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6 min-h-[500px]">
                    <!-- Upcoming Movie thumbnails will be loaded here by JS -->
                </div>
                <div class="flex justify-center mt-10">
                    <button id="load-more-upcoming-movies" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Load more Upcoming Movies">
                        Load More
                    </button>
                </div>
                <div id="loading-spinner-upcoming-movies" class="hidden flex justify-center items-center py-8">
                    <div class="spinner"></div>
                </div>
                <p id="no-results-message-upcoming-movies" class="hidden text-center text-gray-400 text-lg mt-8">No results found for your search.</p>
            </div>

            <!-- Now Playing Movies Section -->
            <div id="now-playing-movies-section" class="mb-12">
                <h2 class="text-3xl font-bold text-gray-100 mb-8 text-center"><span id="section-title-now-playing-movies">Now Playing Movies</span></h2>
                <div id="movie-grid-now-playing-movies" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6 min-h-[500px]">
                    <!-- Now Playing Movie thumbnails will be loaded here by JS -->
                </div>
                <div class="flex justify-center mt-10">
                    <button id="load-more-now-playing-movies" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Load more Now Playing Movies">
                        Load More
                    </button>
                </div>
                <div id="loading-spinner-now-playing-movies" class="hidden flex justify-center items-center py-8">
                    <div class="spinner"></div>
                </div>
                <p id="no-results-message-now-playing-movies" class="hidden text-center text-gray-400 text-lg mt-8">No results found for your search.</p>
            </div>

            <!-- Popular Movies Section -->
            <div id="popular-movies-section" class="mb-12">
                <h2 class="text-3xl font-bold text-gray-100 mb-8 text-center"><span id="section-title-popular-movies">Popular Movies</span></h2>
                <div id="movie-grid-popular-movies" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6 min-h-[500px]">
                    <!-- Popular Movie thumbnails will be loaded here by JS -->
                </div>
                <div class="flex justify-center mt-10">
                    <button id="load-more-popular-movies" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Load more Popular Movies">
                        Load More
                    </button>
                </div>
                <div id="loading-spinner-popular-movies" class="hidden flex justify-center items-center py-8">
                    <div class="spinner"></div>
                </div>
                <p id="no-results-message-popular-movies" class="hidden text-center text-gray-400 text-lg mt-8">No results found for your search.</p>
            </div>

            <!-- Top Rated Movies Section (already exists, will be renamed in JS) -->
            <div id="top-rated-movies-section" class="mb-12">
                <h2 class="text-3xl font-bold text-gray-100 mb-8 text-center"><span id="section-title-top-rated-movies">Top Rated Movies</span></h2>
                <div id="movie-grid-top-rated-movies" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6 min-h-[500px]">
                    <!-- Top Rated Movie thumbnails will be loaded here by JS -->
                </div>
                <div class="flex justify-center mt-10">
                    <button id="load-more-top-rated-movies" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Load more Top Rated Movies">
                        Load More
                    </button>
                </div>
                <div id="loading-spinner-top-rated-movies" class="hidden flex justify-center items-center py-8">
                    <div class="spinner"></div>
                </div>
                <p id="no-results-message-top-rated-movies" class="hidden text-center text-gray-400 text-lg mt-8">No results found for your search.</p>
            </div>

            <!-- TV Series Airing Today Section -->
            <div id="airing-today-tv-section" class="mb-6 hidden">
                <h2 class="text-3xl font-bold text-gray-100 mb-8 text-center"><span id="section-title-airing-today-tv">TV Series Airing Today</span></h2>
                <div id="movie-grid-airing-today-tv" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6 min-h-[500px]">
                    <!-- TV Series Airing Today thumbnails will be loaded here by JS -->
                </div>
                <div class="flex justify-center mt-10">
                    <button id="load-more-airing-today-tv" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Load more TV Series Airing Today">
                        Load More
                    </button>
                </div>
                <div id="loading-spinner-airing-today-tv" class="hidden flex justify-center items-center py-8">
                    <div class="spinner"></div>
                </div>
                <p id="no-results-message-airing-today-tv" class="hidden text-center text-gray-400 text-lg mt-8">No results found for your search.</p>
            </div>

            <!-- On The Air TV Series Section -->
            <div id="on-tv-section" class="mb-6 hidden">
                <h2 class="text-3xl font-bold text-gray-100 mb-8 text-center"><span id="section-title-on-tv">On The Air TV Series</span></h2>
                <div id="movie-grid-on-tv" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6 min-h-[500px]">
                    <!-- On The Air TV Series thumbnails will be loaded here by JS -->
                </div>
                <div class="flex justify-center mt-10">
                    <button id="load-more-on-tv" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Load more On The Air TV Series">
                        Load More
                    </button>
                </div>
                <div id="loading-spinner-on-tv" class="hidden flex justify-center items-center py-8">
                    <div class="spinner"></div>
                </div>
                <p id="no-results-message-on-tv" class="hidden text-center text-gray-400 text-lg mt-8">No results found for your search.</p>
            </div>

            <!-- Popular TV Series Section -->
            <div id="popular-tv-section" class="mb-12 hidden">
                <h2 class="text-3xl font-bold text-gray-100 mb-8 text-center"><span id="section-title-popular-tv">Popular TV Series</span></h2>
                <div id="movie-grid-popular-tv" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6 min-h-[500px]">
                    <!-- Popular TV Series thumbnails will be loaded here by JS -->
                </div>
                <div class="flex justify-center mt-10">
                    <button id="load-more-popular-tv" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Load more Popular TV Series">
                        Load More
                    </button>
                </div>
                <div id="loading-spinner-popular-tv" class="hidden flex justify-center items-center py-8">
                    <div class="spinner"></div>
                </div>
                <p id="no-results-message-popular-tv" class="hidden text-center text-gray-400 text-lg mt-8">No results found for your search.</p>
            </div>

            <!-- Top Rated TV Series Section -->
            <div id="top-rated-tv-section" class="mb-12 hidden">
                <h2 class="text-3xl font-bold text-gray-100 mb-8 text-center"><span id="section-title-top-rated-tv">Top Rated TV Series</span></h2>
                <div id="movie-grid-top-rated-tv" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6 min-h-[500px]">
                    <!-- Top Rated TV Series thumbnails will be loaded here by JS -->
                </div>
                <div class="flex justify-center mt-10">
                    <button id="load-more-top-rated-tv" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Load more Top Rated TV Series">
                        Load More
                    </button>
                </div>
                <div id="loading-spinner-top-rated-tv" class="hidden flex justify-center items-center py-8">
                    <div class="spinner"></div>
                </div>
                <p id="no-results-message-top-rated-tv" class="hidden text-center text-gray-400 text-lg mt-8">No results found for your search.</p>
            </div>
        </section>

        <!-- Layer 2: Movie/TV Detail -->
        <section id="layer-2" class="layer-2 bg-gray-800 p-6 md:p-8 rounded-lg shadow-xl relative">
            <button id="back-to-list-button" class="absolute top-4 left-4 bg-gray-700 hover:bg-gray-600 text-gray-200 p-2 rounded-full shadow-md transition-colors duration-200" aria-label="Back to movie list">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            </button>
            <!-- Loading spinner for Layer 2 -->
            <div id="loading-spinner-layer2" class="flex justify-center items-center h-96">
                <div class="spinner"></div>
            </div>
            <div id="movie-detail-content" class="hidden">
                <!-- Content will be dynamically loaded here by JS -->
            </div>

            <div class="video-container mb-8">
                <iframe id="detail-trailer" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen sandbox="allow-scripts allow-same-origin allow-popups allow-forms" aria-label="Movie Trailer"></iframe>
            </div>

            <div class="flex flex-wrap justify-center gap-4">
                <!-- Stream 1 Button (vidsrc.me) -->
                <button id="stream-1-button" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-3 px-8 rounded-lg shadow-xl transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-rose-500" aria-label="Stream from Source 1">
                    Stream 1
                </button>
                <!-- Stream 2 Button (Ad Trigger) -->
                <button id="stream-2-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-xl transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Open Ad Link">
                    Stream 2
                </button>
            </div>

            <!-- Similar Movie Recommendations -->
            <div class="mt-8 text-center">
                <h3 class="text-2xl font-bold text-gray-100 mb-4">Similar Titles You Might Like:</h3>
                <div id="similar-movies-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                    <!-- Similar movie thumbnails will be loaded here by JS -->
                </div>
                <div id="loading-spinner-similar" class="hidden flex justify-center items-center py-8">
                    <div class="spinner"></div>
                </div>
                <p id="no-similar-results-message" class="hidden text-center text-gray-400 text-lg mt-8">No similar titles found.</p>
            </div>
        </section>

        <!-- Layer 3: Streaming Player -->
        <section id="layer-3" class="layer-3 bg-gray-900 p-4 md:p-8 rounded-lg shadow-xl flex flex-col">
            <button id="back-to-detail-button" class="bg-gray-700 hover:bg-gray-600 text-gray-200 p-2 rounded-full shadow-md mb-4 self-start transition-colors duration-200" aria-label="Back to movie details">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            </button>
            <!-- Loading spinner for Layer 3 -->
            <div id="loading-spinner-layer3" class="flex justify-center items-center flex-grow">
                <div class="spinner"></div>
            </div>
            <div class="flex-grow video-container" id="streaming-player-container">
                <iframe id="streaming-player" src="" frameborder="0" allowfullscreen sandbox="allow-scripts allow-same-origin allow-popups allow-forms" class="rounded-lg" aria-label="Movie Streaming Player"></iframe>
            </div>
            <!-- Direct streaming buttons added -->
            <div class="flex flex-wrap justify-center gap-4 mt-6">
                <button id="stream-3-button" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-3 px-8 rounded-lg shadow-xl transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-rose-500" aria-label="Stream from Source 3">
                    Stream 3
                </button>
                <button id="stream-4-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-xl transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Stream from Source 4">
                    Stream 4
                </button>
            </div>

            <!-- Dynamic thumbnails will be loaded here by JS -->
            <div class="mt-8 text-center">
                <h3 class="text-xl font-bold text-gray-100 mb-4">You Might Also Like This:</h3>
                <div id="static-movie-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                    <!-- Dynamic Romance Movies will be loaded here by JS -->
                </div>
                <div id="loading-spinner-static-grid" class="hidden flex justify-center items-center py-8">
                    <div class="spinner"></div>
                </div>
                <p id="no-results-message-static-grid" class="hidden text-center text-gray-400 text-lg mt-8">No results found.</p>
            </div>
        </section>

        <!-- Layer 4: SEO Content -->
        <section id="layer-4" class="layer-4 px-4 py-12">
            <button id="back-from-seo-button" class="absolute top-4 left-4 bg-gray-700 hover:bg-gray-600 text-gray-200 p-2 rounded-full shadow-md transition-colors duration-200" aria-label="Back from SEO content">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            </button>
            <div id="seo-content" class="layer-4-content">
                <!-- SEO content will be injected here by JavaScript -->
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="w-full mx-auto mt-12 py-8 bg-gray-900 text-gray-400 text-center text-sm border-t border-gray-700 rounded-t-lg">
        <div class="container mx-auto px-4">
            <p>&copy; <span id="current-year"></span> 123Movies UK. All rights reserved.</p>
            <p class="mt-2">
                <a href="#" class="hover:text-white transition-colors duration-200">Privacy Policy</a> | <a href="#" class="hover:text-white transition-colors duration-200">Terms of Service</a> | <a href="#" class="hover:text-white transition-colors duration-200">Contact Us</a>
            </p>
        </div>
    </footer>

    <script type="module">
        // Mengubah TMDB_BASE_URL agar menunjuk ke URL Cloudflare Worker Anda.
        const TMDB_BASE_URL = 'https://tmdb-api-proxy.musadekakhmad.workers.dev'; // Ganti dengan URL Worker Anda yang sebenarnya
        const TMDB_IMAGE_BASE_URL = 'https://image.tmdb.org/t/p/w500';
        const TMDB_PROFILE_IMAGE_BASE_URL = 'https://image.tmdb.org/t/p/w185';

        // Objek state aplikasi terpusat
        const appState = {
            pageCounters: {
                'upcoming-movies': 1,
                'now-playing-movies': 1,
                'popular-movies': 1,
                'top-rated-movies': 1,
                'airing-today-tv': 1,
                'on-tv': 1,
                'popular-tv': 1,
                'top-rated-tv': 1,
                'search': 1 // For search results
            },
            currentSearchQuery: '',
            currentGenreId: null,
            currentMediaId: null,
            currentImdbId: null,
            currentMediaType: 'movie', // Default: 'movie'
            clickCounter: 0, // New: Counter for tracking thumbnail clicks for ad logic
            genres: [] // To store dynamically fetched genres
        };

        // Adsterra Direct Ad URLs - Using 8 example direct links
        const ADSTERRA_DIRECT_LINKS = [
            'https://discreetisabella.com/x818nj48?key=db0a9d9fa9d81626b459383a7bdc33ee',
            'https://discreetisabella.com/gd8bwkyj?key=d2d35cf16f521bf5e9accfdd865dae8f',
            'https://discreetisabella.com/paij3re0by?key=fa60f72b73c05d987bd978f83a6deaa8',
            'https://discreetisabella.com/gh4tkda15?key=080742d09d4b5234a4fdaa773e48ebd4',
            'https://discreetisabella.com/u1ipxidjif?key=bf544685cc418fde38d3de4391de6fee',
            'https://discreetisabella.com/nu4ravi1cx?key=4d0556009c2d17968977e235d5de925a',
            'https://discreetisabella.com/wdhedf2wx?key=a2c98838af4390b59e8b7aaaea3f1660',
            'https://discreetisabella.com/yed8kj7bvw?key=b7830767455354f8e097df2a9e0f040c',
            'https://discreetisabella.com/w2sw8zgx21?key=d34ca1378210247721e98e65d20b3693',
            'https://discreetisabella.com/qn92sfcb?key=a8333f15c6bba15e367a5456f691547c',
            'https://discreetisabella.com/rz2xzbfm?key=8c4045c97068010d84c3f1002e82b1c9'
        ];
        let currentAdLinkIndex = 0; // To rotate through the direct links

        // Function to get the next Adsterra direct link in rotation
        function getNextAdLink() {
            const link = ADSTERRA_DIRECT_LINKS[currentAdLinkIndex];
            currentAdLinkIndex = (currentAdLinkIndex + 1) % ADSTERRA_DIRECT_LINKS.length; // Cycle through links
            return link;
        }

        // New function to handle ad display logic based on click counter
        function triggerAd() {
            appState.clickCounter++; // Increment click counter on every call
            // Trigger ad on 1st, 4th, 7th clicks (i.e., (clickCount - 1) % 3 === 0)
            if ((appState.clickCounter - 1) % 3 === 0) {
                window.open(getNextAdLink(), '_blank', 'noopener noreferrer');
            }
        }

        // Streaming service URLs (abstracted)
        const STREAMING_URLS = {
            'vidsrc.me': (mediaId) => `https://vidsrc.me/embed/${mediaId}`,
            'vidsrc.to-imdb': (imdbId, mediaType) => `https://vidsrc.to/embed/${mediaType === 'movie' ? 'movie' : 'tv'}?imdb=${imdbId}`,
            'vidsrc.to-tmdb': (mediaId, mediaType) => `https://vidsrc.to/embed/${mediaType === 'movie' ? 'movie' : 'tv'}/${mediaId}`
        };


        // DOM Elements
        const layer1 = document.getElementById('layer-1');
        const layer2 = document.getElementById('layer-2');
        const layer3 = document.getElementById('layer-3');
        const layer4 = document.getElementById('layer-4'); // New Layer 4

        const backToListButton = document.getElementById('back-to-list-button');
        const backToDetailButton = document.getElementById('back-to-detail-button');
        const backFromSeoButton = document.getElementById('back-from-seo-button'); // New back button for Layer 4

        const stream1Button = document.getElementById('stream-1-button');
        const stream2Button = document.getElementById('stream-2-button');
        const stream3Button = document.getElementById('stream-3-button');
        const stream4Button = document.getElementById('stream-4-button');

        const staticMovieGrid = document.getElementById('static-movie-grid'); // Get the static movie grid container
        const loadingSpinnerStaticGrid = document.getElementById('loading-spinner-static-grid'); // Spinner for the static grid
        const noResultsMessageStaticGrid = document.getElementById('no-results-message-static-grid'); // No results message for static grid

        const similarMoviesGrid = document.getElementById('similar-movies-grid'); // Get the similar movies grid container
        const loadingSpinnerSimilar = document.getElementById('loading-spinner-similar');
        const noSimilarResultsMessage = document.getElementById('no-similar-results-message');

        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const loadingSpinnerLayer2 = document.getElementById('loading-spinner-layer2');
        const loadingSpinnerLayer3 = document.getElementById('loading-spinner-layer3');

        const navHomeButton = document.getElementById('nav-home-button'); // New Home button
        const navMoviesButton = document.getElementById('nav-movies-button');
        const navTvSeriesButton = document.getElementById('nav-tvseries-button');
        const genreButtonsContainer = document.getElementById('genre-buttons-container'); // Container for dynamic genre buttons

        // Hardcoded strings for English
        const TEXT_CONSTANTS = {
            appTitle: "123Movies UK",
            metaDescription: "123Movies UK: Stream thousands of free movies and TV series online in HD quality. Discover the latest blockbusters, classic films, and popular TV shows with no subscription required. Your ultimate destination for unlimited entertainment, available on any device. Start watching now!",
            metaKeywords: "123Movies UK, free movies, watch movies online, free TV series, stream TV shows, HD streaming, latest movies, popular TV series, no subscription, free entertainment, online cinema, movie streaming site, TV show streaming, watch films, full HD movies, free streaming platform, best free movies, watch series online, online entertainment, movie database, TV show database",
            ogDescription: "123Movies UK: Stream thousands of free movies and TV series online in HD quality. Discover the latest blockbusters, classic films, and popular TV shows with no subscription required. Your ultimate destination for unlimited entertainment, available on any device. Start watching now!",
            homeButton: "Home", // New
            moviesButton: "Movies",
            tvSeriesButton: "TV Series",
            searchMoviesPlaceholder: "Search movies...",
            searchTvSeriesPlaceholder: "Search TV series...",
            upcomingMovies: "Upcoming Movies", // New
            nowPlayingMovies: "Now Playing Movies", // Updated
            popularMovies: "Popular Movies", // New
            topRatedMovies: "Top Rated Movies", // Updated
            // romanceMovies: "Romance Movies", // Removed
            airingTodayTv: "TV Series Airing Today", // New
            onTv: "On The Air TV Series", // New
            popularTv: "Popular TV Series", // Updated
            topRatedTv: "Top Rated TV Series", // New
            loadMoreButton: "Load More",
            noResultsFound: "No results found for your search.",
            posterNotAvailable: "POSTER NOT AVAILABLE",
            imageError: "IMAGE ERROR",
            titleNotAvailable: "Title Not Available",
            yearNotAvailable: "Year Not Available",
            noPoster: "No Poster",
            castPrefix: "Cast: ",
            plotNotAvailable: "No plot available.",
            stream1Button: "Stream 1",
            stream2Button: "Stream 2",
            stream3Button: "Stream 3",
            stream4Button: "Stream 4",
            youMightAlsoLike: "You Might Also Like This:",
            allRightsReserved: "All rights reserved.",
            privacyPolicy: "Privacy Policy",
            termsOfService: "Terms Of Service",
            contactUs: "Contact Us",
            errorTitle: "Error",
            infoTitle: "Info",
            failedToLoadMedia: "Failed to load media. Please try again later.",
            noMediaSelected: "No media selected for streaming.",
            imdbIdNotAvailable: "IMDb ID not available for streaming. Please try Stream 1.",
            invalidMediaHash: "Invalid media hash, loading popular movies.",
            notAvailable: "N/A",
            similarTitles: "Similar Titles You Might Like:",
            noSimilarTitles: "No similar titles found.",
            year: "Year",
            releaseDate: "Release Date",
            director: "Director",
            duration: "Duration",
            userScore: "User Score",
            contentRating: "Content Rating",
            votes: "votes",
            seasons: "seasons",
            episodes: "episodes"
        };

        // Dynamic TMDB endpoints based on media type
        const mediaTypeEndpoints = {
            movie: {
                popular: '/movie/popular',
                now_playing: '/movie/now_playing',
                top_rated: '/movie/top_rated',
                upcoming: '/movie/upcoming', // New
                search: '/search/movie',
                detail: '/movie/',
                videos: '/movie/',
                credits: '/movie/',
                genre: '/discover/movie', // For genre-specific fetches
                genres_list: '/genre/movie/list', // New: For fetching movie genres
                similar: '/movie/' // For similar movies
            },
            tv: {
                popular: '/tv/popular',
                airing_today: '/tv/airing_today', // New
                on_the_air: '/tv/on_the_air',     // New
                top_rated: '/tv/top_rated',       // New
                search: '/search/tv',
                detail: '/tv/',
                videos: '/tv/',
                credits: '/tv/',
                genres_list: '/genre/tv/list', // New: For fetching TV genres
                similar: '/tv/' // For similar TV series
            }
        };

        // Configuration for each section, mapping sectionName to TMDB endpoint and title
        const sectionConfigs = {
            'movie': {
                'upcoming-movies': { endpoint: 'upcoming', title: TEXT_CONSTANTS.upcomingMovies },
                'now-playing-movies': { endpoint: 'now_playing', title: TEXT_CONSTANTS.nowPlayingMovies },
                'popular-movies': { endpoint: 'popular', title: TEXT_CONSTANTS.popularMovies },
                'top-rated-movies': { endpoint: 'top_rated', title: TEXT_CONSTANTS.topRatedMovies },
                'romance-movies-dynamic': { endpoint: 'genre', title: 'Romance Movies (Dynamic)', genreId: 10749 } // Added for dynamic romance
            },
            'tv': {
                'airing-today-tv': { endpoint: 'airing_today', title: TEXT_CONSTANTS.airingTodayTv },
                'on-tv': { endpoint: 'on_the_air', title: TEXT_CONSTANTS.onTv },
                'popular-tv': { endpoint: 'popular', title: TEXT_CONSTANTS.popularTv },
                'top-rated-tv': { endpoint: 'top_rated', title: TEXT_CONSTANTS.topRatedTv }
            }
        };

        // Hardcoded recommended movies for when no similar titles are found
        const recommendedFallbackMovies = [
            { id: 67308, title: '3-D Sex and Zen: Extreme Ecstasy', release_date: '2011-04-14', poster_path: 'https://image.tmdb.org/t/p/w300/jjADiLOmCoXoVldQYrNR9bdAWA0.jpg' },
            { id: 575299, title: 'Fidelity', release_date: '2019-09-06', poster_path: 'https://image.tmdb.org/t/p/w300/kDaRVADrrbwNSGzCvU4AroEa6h1.jpg' },
            { id: 14365, title: 'Killing Me Softly', release_date: '2002-03-29', poster_path: 'https://image.tmdb.org/t/p/w300/pgfFJw7mqAmJdZizrJ6oOK0ejOZ.jpg' },
            { id: 1180449, title: 'They Are Mine', release_date: '2023-10-26', poster_path: 'https://image.tmdb.org/t/p/w300/66kzlgGMp9lKUiBjjPPYG0r8Z03.jpg' },
            { id: 12225, title: 'Cashback', release_date: '2006-09-08', poster_path: 'https://image.tmdb.org/t/p/w300/juTJZCgNwcEeKtrxC6EygC2mKfJ.jpg' },
            { id: 48650, title: 'Room in Rome', release_date: '2010-03-19', poster_path: 'https://image.tmdb.org/t/p/w300/qQ8ithmufWYz0OzJbE2YuAn3Qaj.jpg' }
        ];


        /**
         * Converts text to a URL-friendly slug format.
         * Example: "The Dark Knight" -> "the-dark-knight"
         * @param {string} text - The text to slugify.
         * @returns {string} - The text in slug format.
         */
        function slugify(text) {
            return text
                .toString()
                .normalize('NFD') // Normalizes diacritics
                .replace(/[\u0300-\u036f]/g, '') // Removes diacritics
                .toLowerCase() // Converts to lowercase
                .trim() // Trims leading/trailing whitespace
                .replace(/\s+/g, '-') // Replaces spaces with hyphens
                .replace(/[^\w-]+/g, '') // Removes all non-alphanumeric characters
                .replace(/--+/g, '-'); // Replaces multiple hyphens with a single hyphen
        }

        // Function to show/hide layers
        function showLayer(layerToShow) {
            layer1.style.display = 'none';
            layer2.style.display = 'none';
            layer3.style.display = 'none';
            layer4.style.display = 'none'; // Hide Layer 4 by default
            layerToShow.style.display = 'block';
            window.scrollTo(0, 0); // Scroll to top when changing layers
        }

        /**
         * Displays a custom message box with translatable content.
         * @param {string} titleKey - The key for the title in the TEXT_CONSTANTS object.
         * @param {string} messageKey - The key for the message in the TEXT_CONSTANTS object.
         * @param {Object} [replacements={}] - Optional object for string replacements in the message.
         */
        function showMessageBox(titleKey, messageKey, replacements = {}) {
            let title = TEXT_CONSTANTS[titleKey] || titleKey;
            let message = TEXT_CONSTANTS[messageKey] || messageKey;

            for (const key in replacements) {
                message = message.replace(`{${key}}`, replacements[key]);
            }

            const existingMessageBox = document.getElementById('custom-message-box');
            if (existingMessageBox) {
                existingMessageBox.remove();
            }

            const messageBox = document.createElement('div');
            messageBox.id = 'custom-message-box';
            messageBox.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[1000] p-4';
            messageBox.innerHTML = `
                <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-sm w-full text-center border-t-4 border-indigo-500">
                    <h3 class="text-2xl font-bold text-gray-100 mb-4">${title}</h3>
                    <p class="text-gray-300 mb-6">${message}</p>
                    <button id="message-box-ok" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md shadow-md transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        OK
                    </button>
                </div>
            `;
            document.body.appendChild(messageBox);

            document.getElementById('message-box-ok').addEventListener('click', () => {
                messageBox.remove();
            });
        }

        /**
         * Fetches and displays media for a specific section on Layer 1.
         * @param {string} type - 'movie' or 'tv'.
         * @param {string} sectionName - Identifier for the section (e.g., 'upcoming-movies', 'airing-today-tv').
         * @param {number} page - The page number to fetch.
         * @param {string} [query=''] - Search query, if any.
         * @param {number} [genreId=null] - Genre ID, if filtering by genre.
         */
        async function loadMediaSection(type, sectionName, page = 1, query = '', genreId = null) {
            const gridElement = document.getElementById(`movie-grid-${sectionName}`);
            const loadMoreBtn = document.getElementById(`load-more-${sectionName}`);
            const spinnerElement = document.getElementById(`loading-spinner-${sectionName}`);
            const noResultsMsg = document.getElementById(`no-results-message-${sectionName}`);
            const sectionTitleElement = document.getElementById(`section-title-${sectionName}`);

            spinnerElement.classList.remove('hidden');
            if (page === 1) { // Only clear grid on first page load for a section
                gridElement.innerHTML = '';
            }
            noResultsMsg.classList.add('hidden');
            loadMoreBtn.classList.add('hidden');

            let url = '';
            let titleText = '';

            if (query) {
                url = `${TMDB_BASE_URL}${mediaTypeEndpoints[type].search}?query=${encodeURIComponent(query)}&page=${page}&language=en`;
                titleText = `Search Results for "${query}"`; // Specific title for search
            } else if (genreId) {
                url = `${TMDB_BASE_URL}${mediaTypeEndpoints[type].genre}?with_genres=${genreId}&page=${page}&language=en`;
                const genreName = appState.genres.find(g => g.id === genreId)?.name || 'Movies'; // Get genre name from state
                titleText = `${genreName} ${type === 'movie' ? 'Movies' : 'TV Series'}`; // Dynamic title for genre
            } else {
                const config = sectionConfigs[type][sectionName];
                if (config) {
                    if (config.genreName) { // Special case for genre-based sections like Romance Movies
                        const genre = appState.genres.find(g => g.name === config.genreName);
                        if (genre) {
                            url = `${TMDB_BASE_URL}${mediaTypeEndpoints[type].genre}?with_genres=${genre.id}&page=${page}&language=en`;
                        } else {
                            console.warn(`${config.genreName} genre not found for ${type}, falling back to popular.`);
                            url = `${TMDB_BASE_URL}${mediaTypeEndpoints[type].popular}?page=${page}&language=en`;
                            titleText = type === 'movie' ? TEXT_CONSTANTS.popularMovies : TEXT_CONSTANTS.popularTv;
                        }
                    } else { // Standard endpoint sections
                        url = `${TMDB_BASE_URL}/${type}/${config.endpoint}?page=${page}&language=en`;
                    }
                    titleText = config.title;
                } else {
                    console.error(`Unknown sectionName: ${sectionName} for type: ${type}. Falling back to popular.`);
                    url = `${TMDB_BASE_URL}${mediaTypeEndpoints[type].popular}?page=${page}&language=en`;
                    titleText = type === 'movie' ? TEXT_CONSTANTS.popularMovies : TEXT_CONSTANTS.popularTv;
                }
            }

            sectionTitleElement.textContent = titleText; // Update section title

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data.results.length === 0 && page === 1) {
                    noResultsMsg.classList.remove('hidden');
                    noResultsMsg.textContent = TEXT_CONSTANTS.noResultsFound;
                    loadMoreBtn.classList.add('hidden');
                } else if (data.results.length > 0) {
                    noResultsMsg.classList.add('hidden');
                    // Limit the number of displayed items to 12
                    data.results.slice(0, 12).forEach(media => {
                        const mediaCard = document.createElement('div');
                        mediaCard.className = 'bg-gray-800 rounded-lg shadow-md overflow-hidden transform transition-all duration-300 hover:scale-105 hover:shadow-xl cursor-pointer';
                        mediaCard.dataset.mediaId = media.id;
                        mediaCard.dataset.mediaType = type; // Store media type in dataset
                        mediaCard.setAttribute('aria-label', `Watch ${media.title || media.name}`); // Added ARIA label

                        const posterPath = media.poster_path ? `${TMDB_IMAGE_BASE_URL}${media.poster_path}` : `https://placehold.co/500x750/FF0000/FFFFFF?text=${TEXT_CONSTANTS.posterNotAvailable}`;
                        const titleOrName = media.title || media.name || TEXT_CONSTANTS.titleNotAvailable;
                        const releaseDateOrFirstAirDate = media.release_date ? media.release_date.substring(0, 4) : (media.first_air_date ? media.first_air_date.substring(0, 4) : TEXT_CONSTANTS.yearNotAvailable);

                        mediaCard.innerHTML = `
                            <img src="${posterPath}" alt="${titleOrName} Poster" loading="lazy" class="w-full h-auto object-cover rounded-t-lg" onerror="this.src='https://placehold.co/300x450/FF0000/FFFFFF?text=${TEXT_CONSTANTS.imageError}';">
                            <div class="p-4 text-center">
                                <h3 class="text-lg font-semibold text-gray-100 truncate">${titleOrName}</h3>
                                <p class="text-gray-400 text-sm">${releaseDateOrFirstAirDate}</p>
                            </div>
                        `;
                        gridElement.appendChild(mediaCard);

                        mediaCard.addEventListener('click', () => {
                            triggerAd(); // Trigger ad on any media card click
                            // Update hash instead of direct call to prevent double loading
                            window.location.hash = `#/media/${type}/${media.id}/${slugify(titleOrName)}`;
                        });
                    });
                }

                if (data.page >= data.total_pages) {
                    loadMoreBtn.classList.add('hidden');
                } else {
                    loadMoreBtn.classList.remove('hidden');
                }

                appState.pageCounters[sectionName] = data.page; // Update specific page counter
            } catch (error) {
                console.error(`Error fetching media for ${sectionName} section:`, error);
                showMessageBox('errorTitle', 'failedToLoadMedia');
                loadMoreBtn.classList.add('hidden');
                noResultsMsg.classList.remove('hidden');
                noResultsMsg.textContent = TEXT_CONSTANTS.failedToLoadMedia;
            } finally {
                spinnerElement.classList.add('hidden');
            }
        }

        /**
         * Fetches and displays media for the static movie grid (now dynamic Romance Movies).
         */
        async function loadRomanceMoviesIntoStaticGrid() {
            staticMovieGrid.innerHTML = ''; // Clear previous content
            loadingSpinnerStaticGrid.classList.remove('hidden');
            noResultsMessageStaticGrid.classList.add('hidden');

            const romanceGenreId = sectionConfigs.movie['romance-movies-dynamic'].genreId;
            const url = `${TMDB_BASE_URL}${mediaTypeEndpoints.movie.genre}?with_genres=${romanceGenreId}&page=1&language=en`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data.results.length === 0) {
                    noResultsMessageStaticGrid.classList.remove('hidden');
                    noResultsMessageStaticGrid.textContent = TEXT_CONSTANTS.noResultsFound;
                } else {
                    noResultsMessageStaticGrid.classList.add('hidden');
                    // Limit to 12 items for the "You Might Also Like This" section
                    data.results.slice(0, 12).forEach(media => {
                        const mediaCard = document.createElement('div');
                        mediaCard.className = 'bg-gray-800 rounded-lg shadow-md overflow-hidden transform transition-all duration-300 hover:scale-105 hover:shadow-xl cursor-pointer';
                        mediaCard.dataset.mediaId = media.id;
                        mediaCard.dataset.mediaType = 'movie'; // Always 'movie' for this section
                        mediaCard.setAttribute('aria-label', `Watch ${media.title || media.name}`);

                        const posterPath = media.poster_path ? `${TMDB_IMAGE_BASE_URL}${media.poster_path}` : `https://placehold.co/500x750/FF0000/FFFFFF?text=${TEXT_CONSTANTS.posterNotAvailable}`;
                        const titleOrName = media.title || media.name || TEXT_CONSTANTS.titleNotAvailable;
                        const releaseDateOrFirstAirDate = media.release_date ? media.release_date.substring(0, 4) : (media.first_air_date ? media.first_air_date.substring(0, 4) : TEXT_CONSTANTS.yearNotAvailable);

                        mediaCard.innerHTML = `
                            <img src="${posterPath}" alt="${titleOrName} Poster" loading="lazy" class="w-full h-auto object-cover rounded-t-lg" onerror="this.src='https://placehold.co/300x450/FF0000/FFFFFF?text=${TEXT_CONSTANTS.imageError}';">
                            <div class="p-4 text-center">
                                <h3 class="text-lg font-semibold text-gray-100 truncate">${titleOrName}</h3>
                                <p class="text-gray-400 text-sm">${releaseDateOrFirstAirDate}</p>
                            </div>
                        `;
                        staticMovieGrid.appendChild(mediaCard);

                        mediaCard.addEventListener('click', () => {
                            triggerAd();
                            window.location.hash = `#/media/movie/${media.id}/${slugify(titleOrName)}`;
                        });
                    });
                }
            } catch (error) {
                console.error('Error fetching romance movies for static grid:', error);
                noResultsMessageStaticGrid.classList.remove('hidden');
                noResultsMessageStaticGrid.textContent = TEXT_CONSTANTS.failedToLoadMedia;
            } finally {
                loadingSpinnerStaticGrid.classList.add('hidden');
            }
        }


        // Function to fetch and display movie/TV details (Layer 2)
        async function fetchAndDisplayMediaDetail(mediaId, mediaType, mediaTitleForSlug = '') {
            showLayer(layer2);
            document.getElementById('movie-detail-content').classList.add('hidden');
            loadingSpinnerLayer2.classList.remove('hidden');

            try {
                const detailResponse = await fetch(`${TMDB_BASE_URL}${mediaTypeEndpoints[mediaType].detail}${mediaId}?language=en`);
                if (!detailResponse.ok) throw new Error(`HTTP error! status: ${detailResponse.status}`);
                const media = await detailResponse.json();

                // Update URL hash for uniqueness (only if not already set by handleHashChange)
                const mediaSlug = slugify(media.title || media.name || TEXT_CONSTANTS.titleNotAvailable);
                if (window.location.hash !== `#/media/${mediaType}/${media.id}/${mediaSlug}`) {
                    window.location.hash = `#/media/${mediaType}/${media.id}/${mediaSlug}`;
                }

                const videoResponse = await fetch(`${TMDB_BASE_URL}${mediaTypeEndpoints[mediaType].videos}${mediaId}/videos?language=en`);
                if (!videoResponse.ok) throw new Error(`HTTP error! status: ${videoResponse.status}`);
                const videosData = await videoResponse.json();

                let trailer = videosData.results.find(vid => vid.type === 'Trailer' && vid.site === 'YouTube');
                
                // Fallback: if no specific 'Trailer' type is found, try any YouTube video
                if (!trailer) {
                    trailer = videosData.results.find(vid => vid.site === 'YouTube');
                }

                // Using a relevant movie trailer compilation as fallback if no specific trailer is found
                const trailerUrl = trailer ? `https://www.youtube.com/embed/${trailer.key}` : 'https://www.youtube.com/embed/DmwYqQki_Ic'; // Changed fallback URL

                const creditsResponse = await fetch(`${TMDB_BASE_URL}${mediaTypeEndpoints[mediaType].credits}${mediaId}/credits?language=en`);
                if (!creditsResponse.ok) throw new Error(`HTTP error! status: ${creditsResponse.status}`);
                const creditsData = await creditsResponse.json();
                
                const director = creditsData.crew.find(person => person.job === 'Director');
                const directorName = director ? director.name : TEXT_CONSTANTS.notAvailable;
                const cast = creditsData.cast.slice(0, 5).map(person => person.name).join(', '); // Top 5 cast members

                // Fetch content rating
                let contentRating = TEXT_CONSTANTS.notAvailable;
                if (mediaType === 'movie') {
                    const releaseDatesResponse = await fetch(`${TMDB_BASE_URL}/movie/${mediaId}/release_dates`);
                    if (releaseDatesResponse.ok) {
                        const releaseDatesData = await releaseDatesResponse.json();
                        const usRelease = releaseDatesData.results.find(res => res.iso_3166_1 === 'US');
                        if (usRelease && usRelease.release_dates.length > 0) {
                            contentRating = usRelease.release_dates[0].certification || TEXT_CONSTANTS.notAvailable;
                        }
                    }
                } else if (mediaType === 'tv') {
                    const contentRatingsResponse = await fetch(`${TMDB_BASE_URL}/tv/${mediaId}/content_ratings`);
                    if (contentRatingsResponse.ok) {
                        const contentRatingsData = await contentRatingsResponse.json();
                        const usRating = contentRatingsData.results.find(res => res.iso_3166_1 === 'US');
                        if (usRating) {
                            contentRating = usRating.rating || TEXT_CONSTANTS.notAvailable;
                        }
                    }
                }

                // Prepare duration text
                let durationText = TEXT_CONSTANTS.notAvailable;
                if (mediaType === 'movie' && media.runtime) {
                    const hours = Math.floor(media.runtime / 60);
                    const minutes = media.runtime % 60;
                    durationText = `${hours}h ${minutes}m`;
                } else if (mediaType === 'tv') {
                    if (media.number_of_seasons && media.number_of_episodes) {
                        durationText = `${media.number_of_seasons} ${TEXT_CONSTANTS.seasons}, ${TEXT_CONSTANTS.episodes} ${media.number_of_episodes}`;
                    } else if (media.number_of_seasons) {
                        durationText = `${media.number_of_seasons} ${TEXT_CONSTANTS.seasons}`;
                    } else if (media.number_of_episodes) {
                        durationText = `${media.number_of_episodes} ${TEXT_CONSTANTS.episodes}`;
                    }
                }

                // Update currentImdbId in appState
                appState.currentImdbId = media.imdb_id; // IMDb ID is available for both movies and TV in TMDB details

                // Populate Layer 2 with enhanced details
                const releaseYear = media.release_date ? media.release_date.substring(0, 4) : (media.first_air_date ? media.first_air_date.substring(0, 4) : TEXT_CONSTANTS.notAvailable);
                const fullReleaseDate = media.release_date || media.first_air_date || TEXT_CONSTANTS.notAvailable;

                const detailContentHtml = `
                    <div class="flex flex-col md:flex-row gap-8 mb-8">
                        <img id="detail-poster" src="${media.poster_path ? `${TMDB_IMAGE_BASE_URL}${media.poster_path}` : `https://placehold.co/500x750/374151/d1d5db?text=${TEXT_CONSTANTS.noPoster}`}" alt="${media.title || media.name || 'Media'} Poster" class="w-full md:w-1/3 lg:w-1/4 rounded-lg shadow-md object-cover">
                        <div class="flex-1">
                            <h2 id="detail-title" class="text-4xl font-bold text-gray-100 mb-2">${media.title || media.name || TEXT_CONSTANTS.notAvailable}</h2>
                            <p class="text-gray-400 mb-2">${media.genres.map(g => g.name).join(', ') || TEXT_CONSTANTS.notAvailable}</p>
                            
                            <div class="flex items-center gap-4 mb-4">
                                <p class="text-yellow-500 font-semibold text-lg" aria-label="User score: ${media.vote_average ? media.vote_average.toFixed(1) : 'N/A'} out of 10">⭐ ${media.vote_average ? media.vote_average.toFixed(1) : TEXT_CONSTANTS.notAvailable} / 10</p>
                                <p class="text-gray-300 text-sm">(${media.vote_count || 0} ${TEXT_CONSTANTS.votes})</p>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-gray-300 text-sm mb-4">
                                <p><span class="font-semibold">${TEXT_CONSTANTS.year}:</span> ${releaseYear}</p>
                                <p><span class="font-semibold">${TEXT_CONSTANTS.releaseDate}:</span> ${fullReleaseDate}</p>
                                <p><span class="font-semibold">${TEXT_CONSTANTS.director}:</span> ${directorName}</p>
                                <p><span class="font-semibold">${TEXT_CONSTANTS.duration}:</span> ${durationText}</p>
                                <p><span class="font-semibold">${TEXT_CONSTANTS.contentRating}:</span> ${contentRating}</p>
                            </div>

                            <p id="detail-cast" class="text-gray-300 text-sm mb-4">Cast: ${cast || TEXT_CONSTANTS.notAvailable}</p>
                            <p id="detail-plot" class="text-gray-200 leading-relaxed mb-6 text-justify">${media.overview || TEXT_CONSTANTS.plotNotAvailable}</p>
                        </div>
                    </div>
                `;
                document.getElementById('movie-detail-content').innerHTML = detailContentHtml; // Replace innerHTML

                document.getElementById('detail-trailer').src = trailerUrl;

                // Load similar movies/TV series
                await loadSimilarMedia(mediaId, mediaType);

            } catch (error) {
                console.error('Error fetching media details:', error);
                showMessageBox('errorTitle', 'failedToLoadDetails');
                // Optionally, go back to layer 1 on error
                showLayer(layer1);
                window.location.hash = ''; // Clear hash on error
            } finally {
                loadingSpinnerLayer2.classList.add('hidden');
                document.getElementById('movie-detail-content').classList.remove('hidden');
            }
        }

        /**
         * Fetches and displays similar media.
         * @param {number} mediaId - The ID of the current media.
         * @param {string} mediaType - 'movie' or 'tv'.
         */
        async function loadSimilarMedia(mediaId, mediaType) {
            similarMoviesGrid.innerHTML = ''; // Clear previous similar movies
            loadingSpinnerSimilar.classList.remove('hidden');
            noSimilarResultsMessage.classList.add('hidden');

            try {
                const similarUrl = `${TMDB_BASE_URL}${mediaTypeEndpoints[mediaType].similar}${mediaId}/similar?language=en&page=1`;
                const response = await fetch(similarUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data.results.length === 0) {
                    // If no similar titles found, display hardcoded recommendations
                    noSimilarResultsMessage.classList.remove('hidden');
                    noSimilarResultsMessage.textContent = TEXT_CONSTANTS.noSimilarTitles; // Keep original message
                    
                    // Populate with recommended fallback movies
                    recommendedFallbackMovies.forEach(recMedia => { 
                        const mediaCard = document.createElement('div');
                        mediaCard.className = 'bg-gray-800 rounded-lg shadow-md overflow-hidden transform transition-all duration-300 hover:scale-105 hover:shadow-xl cursor-pointer';
                        mediaCard.dataset.mediaId = recMedia.id;
                        mediaCard.dataset.mediaType = 'movie'; // Assuming fallback are all movies
                        mediaCard.setAttribute('aria-label', `Watch ${recMedia.title || recMedia.name}`); // Added ARIA label
                        
                        const posterPath = recMedia.poster_path ? `${recMedia.poster_path}` : `https://placehold.co/500x750/FF0000/FFFFFF?text=${TEXT_CONSTANTS.posterNotAvailable}`;
                        const titleOrName = recMedia.title || recMedia.name || TEXT_CONSTANTS.titleNotAvailable;
                        const releaseDateOrFirstAirDate = recMedia.release_date ? recMedia.release_date.substring(0, 4) : (recMedia.first_air_date ? recMedia.first_air_date.substring(0, 4) : TEXT_CONSTANTS.yearNotAvailable);

                        mediaCard.innerHTML = `
                            <img src="${posterPath}" alt="${titleOrName} Poster" loading="lazy" class="w-full h-auto object-cover rounded-t-lg" onerror="this.src='https://placehold.co/300x450/FF0000/FFFFFF?text=${TEXT_CONSTANTS.imageError}';">
                            <div class="p-4 text-center">
                                <h3 class="text-lg font-semibold text-gray-100 truncate">${titleOrName}</h3>
                                <p class="text-gray-400 text-sm">${releaseDateOrFirstAirDate}</p>
                            </div>
                        `;
                        similarMoviesGrid.appendChild(mediaCard);

                        mediaCard.addEventListener('click', () => {
                            triggerAd(); // Trigger ad on any media card click
                            // Update hash instead of direct call to prevent double loading
                            window.location.hash = `#/media/movie/${recMedia.id}/${slugify(titleOrName)}`;
                        });
                    });

                } else {
                    // Ensure only 6 items are displayed for similar movies (changed from 5 to 6)
                    data.results.slice(0, 6).forEach(similarMedia => { 
                        const mediaCard = document.createElement('div');
                        mediaCard.className = 'bg-gray-800 rounded-lg shadow-md overflow-hidden transform transition-all duration-300 hover:scale-105 hover:shadow-xl cursor-pointer';
                        mediaCard.dataset.mediaId = similarMedia.id;
                        mediaCard.dataset.mediaType = mediaType; // Similar items are of the same type
                        mediaCard.setAttribute('aria-label', `Watch ${similarMedia.title || similarMedia.name}`); // Added ARIA label
                        
                        const posterPath = similarMedia.poster_path ? `${TMDB_IMAGE_BASE_URL}${similarMedia.poster_path}` : `https://placehold.co/500x750/FF0000/FFFFFF?text=${TEXT_CONSTANTS.posterNotAvailable}`;
                        const titleOrName = similarMedia.title || similarMedia.name || TEXT_CONSTANTS.titleNotAvailable;
                        const releaseDateOrFirstAirDate = similarMedia.release_date ? similarMedia.release_date.substring(0, 4) : (similarMedia.first_air_date ? similarMedia.first_air_date.substring(0, 4) : TEXT_CONSTANTS.yearNotAvailable);

                        mediaCard.innerHTML = `
                            <img src="${posterPath}" alt="${titleOrName} Poster" loading="lazy" class="w-full h-auto object-cover rounded-t-lg" onerror="this.src='https://placehold.co/300x450/FF0000/FFFFFF?text=${TEXT_CONSTANTS.imageError}';">
                            <div class="p-4 text-center">
                                <h3 class="text-lg font-semibold text-gray-100 truncate">${titleOrName}</h3>
                                <p class="text-gray-400 text-sm">${releaseDateOrFirstAirDate}</p>
                            </div>
                        `;
                        similarMoviesGrid.appendChild(mediaCard);

                        mediaCard.addEventListener('click', () => {
                            triggerAd(); // Trigger ad on any media card click
                            // Update hash instead of direct call to prevent double loading
                            window.location.hash = `#/media/${mediaType}/${similarMedia.id}/${slugify(titleOrName)}`;
                        });
                    });
                }
            } catch (error) {
                console.error('Error fetching similar media:', error);
                noSimilarResultsMessage.classList.remove('hidden');
                noSimilarResultsMessage.textContent = TEXT_CONSTANTS.failedToLoadMedia;
            } finally {
                loadingSpinnerSimilar.classList.add('hidden');
            }
        }

        /**
         * Loads the streaming player iframe with the appropriate URL.
         * @param {string} sourceKey - The key for the streaming source in STREAMING_URLS.
         */
        function loadStreamingPlayer(sourceKey) {
            if (!appState.currentMediaId) {
                showMessageBox('errorTitle', 'noMediaSelected');
                return;
            }

            showLayer(layer3);
            document.getElementById('streaming-player-container').classList.add('hidden');
            loadingSpinnerLayer3.classList.remove('hidden');

            let streamingUrl = '';
            if (sourceKey === 'vidsrc.me') {
                streamingUrl = STREAMING_URLS['vidsrc.me'](appState.currentMediaId);
            } else if (sourceKey === 'vidsrc.to-imdb') {
                if (!appState.currentImdbId) {
                    showMessageBox('errorTitle', 'imdbIdNotAvailable');
                    loadingSpinnerLayer3.classList.add('hidden');
                    return;
                }
                streamingUrl = STREAMING_URLS['vidsrc.to-imdb'](appState.currentImdbId, appState.currentMediaType);
            } else if (sourceKey === 'vidsrc.to-tmdb') {
                streamingUrl = STREAMING_URLS['vidsrc.to-tmdb'](appState.currentMediaId, appState.currentMediaType);
            }

            document.getElementById('streaming-player').src = streamingUrl;
            document.getElementById('streaming-player').onload = () => {
                loadingSpinnerLayer3.classList.add('hidden');
                document.getElementById('streaming-player-container').classList.remove('hidden');
            };
            // Fallback to hide spinner after a delay if onload event doesn't fire for some reason
            setTimeout(() => {
                loadingSpinnerLayer3.classList.add('hidden');
                document.getElementById('streaming-player-container').classList.remove('hidden');
            }, 3000); // 3-second delay

            // Load dynamic romance movies into the static grid section
            loadRomanceMoviesIntoStaticGrid();
        }


        // Function to show all movie sections and hide TV sections
        async function loadAllMovieSections() {
            // Reset page counters for all movie sections
            appState.pageCounters['upcoming-movies'] = 1;
            appState.pageCounters['now-playing-movies'] = 1;
            appState.pageCounters['popular-movies'] = 1;
            appState.pageCounters['top-rated-movies'] = 1;

            appState.currentSearchQuery = '';
            searchInput.value = '';
            appState.currentGenreId = null;

            // Hide all TV sections
            document.getElementById('airing-today-tv-section').style.display = 'none';
            document.getElementById('on-tv-section').style.display = 'none';
            document.getElementById('popular-tv-section').style.display = 'none';
            document.getElementById('top-rated-tv-section').style.display = 'none';

            // Show all movie sections
            document.getElementById('upcoming-movies-section').style.display = 'block';
            document.getElementById('now-playing-movies-section').style.display = 'block';
            document.getElementById('popular-movies-section').style.display = 'block';
            document.getElementById('top-rated-movies-section').style.display = 'block';


            try {
                await Promise.all([
                    loadMediaSection('movie', 'upcoming-movies', 1),
                    loadMediaSection('movie', 'now-playing-movies', 1),
                    loadMediaSection('movie', 'popular-movies', 1),
                    loadMediaSection('movie', 'top-rated-movies', 1)
                ]);
            } catch (error) {
                console.error("Error loading all movie sections:", error);
                showMessageBox('errorTitle', 'failedToLoadMedia');
            }
        }

        // Function to show all TV sections and hide movie sections
        async function loadAllTvSections() {
            // Reset page counters for all TV sections
            appState.pageCounters['airing-today-tv'] = 1;
            appState.pageCounters['on-tv'] = 1;
            appState.pageCounters['popular-tv'] = 1;
            appState.pageCounters['top-rated-tv'] = 1;

            appState.currentSearchQuery = '';
            searchInput.value = '';
            appState.currentGenreId = null;

            // Hide all movie sections
            document.getElementById('upcoming-movies-section').style.display = 'none';
            document.getElementById('now-playing-movies-section').style.display = 'none';
            document.getElementById('popular-movies-section').style.display = 'none';
            document.getElementById('top-rated-movies-section').style.display = 'none';
            // Ensure these elements are checked for existence before attempting to access their style property
            const romanceMoviesSection = document.getElementById('romance-movies-section');
            if (romanceMoviesSection) {
                romanceMoviesSection.style.display = 'none';
            }


            // Show all TV sections
            document.getElementById('airing-today-tv-section').style.display = 'block';
            document.getElementById('on-tv-section').style.display = 'block';
            document.getElementById('popular-tv-section').style.display = 'block';
            document.getElementById('top-rated-tv-section').style.display = 'block';

            try {
                await Promise.all([
                    loadMediaSection('tv', 'airing-today-tv', 1),
                    loadMediaSection('tv', 'on-tv', 1),
                    loadMediaSection('tv', 'popular-tv', 1),
                    loadMediaSection('tv', 'top-rated-tv', 1)
                ]);
            } catch (error) {
                console.error("Error loading all TV sections:", error);
                showMessageBox('errorTitle', 'failedToLoadMedia');
            }
        }

        // Function to handle URL hash changes
        async function handleHashChange() {
            const hash = window.location.hash;

            if (hash.startsWith('#/media/')) {
                const parts = hash.split('/');
                if (parts.length >= 4) { // e.g., #/media/movie/123/title-slug
                    const type = parts[2];
                    const id = parts[3];
                    // The slug (parts[4]) is optional for loading, but good for SEO.

                    if ((type === 'movie' || type === 'tv') && !isNaN(id)) {
                        // Prevent redundant calls if already on the same detail page
                        if (appState.currentMediaId === id && appState.currentMediaType === type && layer2.style.display === 'block') {
                            return;
                        }
                        appState.currentMediaId = id;
                        appState.currentMediaType = type;
                        // Hide all sections on Layer 1 when viewing details
                        document.getElementById('upcoming-movies-section').style.display = 'none';
                        document.getElementById('now-playing-movies-section').style.display = 'none';
                        document.getElementById('popular-movies-section').style.display = 'none';
                        document.getElementById('top-rated-movies-section').style.display = 'none';
                        // Removed: document.getElementById('romance-movies-section').style.display = 'none'; // This line was causing the error
                        // Ensure these elements are checked for existence before attempting to access their style property
                        const romanceMoviesSection = document.getElementById('romance-movies-section');
                        if (romanceMoviesSection) {
                            romanceMoviesSection.style.display = 'none';
                        }
                        document.getElementById('airing-today-tv-section').style.display = 'none';
                        document.getElementById('on-tv-section').style.display = 'none';
                        document.getElementById('popular-tv-section').style.display = 'none';
                        document.getElementById('top-rated-tv-section').style.display = 'none';
                        genreButtonsContainer.classList.add('hidden'); // Hide genre buttons
                        await fetchAndDisplayMediaDetail(id, type);
                    } else {
                        // Invalid hash, revert to home (SEO content)
                        window.location.hash = '#/home-seo';
                    }
                }
            } else if (hash === '#/movies') {
                appState.currentMediaType = 'movie';
                await loadGenreButtons('movie'); // Load movie genres
                genreButtonsContainer.classList.remove('hidden'); // Show genre buttons for movies
                loadAllMovieSections(); // This will reset page counters and load movie sections
                showLayer(layer1);
            } else if (hash === '#/tv') {
                appState.currentMediaType = 'tv';
                await loadGenreButtons('tv'); // Load TV genres
                genreButtonsContainer.classList.remove('hidden'); // Show genre buttons for TV
                loadAllTvSections(); // This will reset page counters and load TV sections
                showLayer(layer1);
            } else if (hash === '#/home-seo') { // New hash for Layer 4
                showLayer(layer4);
                genreButtonsContainer.classList.add('hidden'); // Hide genre buttons
                loadSeoContent(); // Call loadSeoContent when navigating to Layer 4
            }
            else {
                // Default: empty hash or unrecognized hash, load home (SEO content)
                window.location.hash = '#/home-seo';
            }
        }

        /**
         * Debounce function to limit how often a function can be called.
         * @param {Function} func - The function to debounce.
         * @param {number} delay - The delay in milliseconds.
         * @returns {Function} - The debounced function.
         */
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        // Function to load movie or TV genres dynamically and create buttons
        async function loadGenreButtons(type) {
            try {
                const response = await fetch(`${TMDB_BASE_URL}${mediaTypeEndpoints[type].genres_list}?language=en`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                appState.genres = data.genres; // Store genres in appState

                genreButtonsContainer.innerHTML = ''; // Clear existing buttons
                if (data.genres.length > 0) {
                    data.genres.forEach(genre => {
                        const button = document.createElement('button');
                        // Reduced font size to 'xs' (0.75rem) and padding to 'py-1 px-2' (reduced px from 3 to 2)
                        button.className = 'bg-gray-700 hover:bg-purple-600 text-gray-100 font-medium py-1 px-2 rounded-md transition-all duration-200 text-sm md:text-base';
                        button.textContent = genre.name;
                        button.dataset.genreId = genre.id;
                        button.dataset.mediaType = type; // Store media type for genre button
                        button.setAttribute('aria-label', `Filter by ${genre.name} genre`); // Added ARIA label
                        button.addEventListener('click', () => {
                            triggerAd(); // Trigger ad on genre button click
                            appState.currentGenreId = genre.id;
                            appState.currentSearchQuery = ''; // Clear search query
                            searchInput.value = ''; // Clear search input

                            // Hide all sections first
                            document.getElementById('upcoming-movies-section').style.display = 'none';
                            document.getElementById('now-playing-movies-section').style.display = 'none';
                            document.getElementById('popular-movies-section').style.display = 'none';
                            document.getElementById('top-rated-movies-section').style.display = 'none';
                            // Ensure this is also hidden
                            const romanceMoviesSection = document.getElementById('romance-movies-section');
                            if (romanceMoviesSection) {
                                romanceMoviesSection.style.display = 'none';
                            }
                            document.getElementById('airing-today-tv-section').style.display = 'none';
                            document.getElementById('on-tv-section').style.display = 'none';
                            document.getElementById('popular-tv-section').style.display = 'none';
                            document.getElementById('top-rated-tv-section').style.display = 'none';

                            // Show only the "popular-movies-section" grid for movie genre results,
                            // or "popular-tv-section" for TV genre results.
                            const targetSectionId = type === 'movie' ? 'popular-movies-section' : 'popular-tv-section';
                            document.getElementById(targetSectionId).style.display = 'block';

                            // Reset page counter for the target section when filtering by genre
                            appState.pageCounters[targetSectionId.replace('-section', '')] = 1;
                            loadMediaSection(type, targetSectionId.replace('-section', ''), 1, '', genre.id);
                        });
                        genreButtonsContainer.appendChild(button);
                    });
                    genreButtonsContainer.classList.remove('hidden'); // Show genre buttons if there are genres
                } else {
                    genreButtonsContainer.classList.add('hidden'); // Hide if no genres
                }
            } catch (error) {
                console.error("Error fetching genres:", error);
                genreButtonsContainer.classList.add('hidden'); // Ensure hidden on error
                // Optionally show a message to the user
            }
        }

        // Event Listeners for Load More Buttons
        document.getElementById('load-more-upcoming-movies').addEventListener('click', () => {
            triggerAd();
            loadMediaSection('movie', 'upcoming-movies', appState.pageCounters['upcoming-movies'] + 1);
        });
        document.getElementById('load-more-now-playing-movies').addEventListener('click', () => {
            triggerAd();
            loadMediaSection('movie', 'now-playing-movies', appState.pageCounters['now-playing-movies'] + 1);
        });
        document.getElementById('load-more-popular-movies').addEventListener('click', () => {
            triggerAd();
            loadMediaSection('movie', 'popular-movies', appState.pageCounters['popular-movies'] + 1);
        });
        document.getElementById('load-more-top-rated-movies').addEventListener('click', () => {
            triggerAd();
            loadMediaSection('movie', 'top-rated-movies', appState.pageCounters['top-rated-movies'] + 1);
        });

        // New TV Load More buttons
        document.getElementById('load-more-airing-today-tv').addEventListener('click', () => {
            triggerAd();
            loadMediaSection('tv', 'airing-today-tv', appState.pageCounters['airing-today-tv'] + 1);
        });
        document.getElementById('load-more-on-tv').addEventListener('click', () => {
            triggerAd();
            loadMediaSection('tv', 'on-tv', appState.pageCounters['on-tv'] + 1);
        });
        document.getElementById('load-more-popular-tv').addEventListener('click', () => {
            triggerAd();
            loadMediaSection('tv', 'popular-tv', appState.pageCounters['popular-tv'] + 1);
        });
        document.getElementById('load-more-top-rated-tv').addEventListener('click', () => {
            triggerAd();
            loadMediaSection('tv', 'top-rated-tv', appState.pageCounters['top-rated-tv'] + 1);
        });


        backToListButton.addEventListener('click', () => {
            // Determine which "home" view to return to based on currentMediaType
            if (appState.currentMediaType === 'movie') {
                window.location.hash = '#/movies';
            } else { // 'tv'
                window.location.hash = '#/tv';
            }
        });

        backToDetailButton.addEventListener('click', () => {
            showLayer(layer2);
            // Stop streaming when going back to details
            document.getElementById('streaming-player').src = '';
            document.getElementById('streaming-player-container').classList.add('hidden');
            // No need to change hash here, as we are navigating within the detail view context
        });

        backFromSeoButton.addEventListener('click', () => { // New event listener for Layer 4 back button
            // If coming from the main URL, clicking back should lead to Layer 1 (Movies)
            window.location.hash = '#/movies';
        });

        stream1Button.addEventListener('click', () => {
            triggerAd(); // Trigger ad on stream button click
            loadStreamingPlayer('vidsrc.me');
        });

        stream2Button.addEventListener('click', () => {
            triggerAd(); // Trigger ad on stream button click
            if (appState.currentMediaId) { // Check if media is selected before trying to open ad
                window.open(getNextAdLink(), '_blank', 'noopener noreferrer'); // Open ad link directly
            } else {
                showMessageBox('errorTitle', 'noMediaSelected');
            }
        });

        stream3Button.addEventListener('click', () => {
            triggerAd(); // Trigger ad on stream button click
            if (appState.currentMediaId) {
                window.open(getNextAdLink(), '_blank', 'noopener noreferrer'); // Use rotating link for Adsterra
            } else {
                showMessageBox('errorTitle', 'noMediaSelected');
            }
        });

        stream4Button.addEventListener('click', () => {
            triggerAd(); // Trigger ad on stream button click
            loadStreamingPlayer('vidsrc.to-tmdb'); // Now uses TMDB ID for vidsrc.to
        });

        // Debounced search function
        const debouncedSearch = debounce(() => {
            const query = searchInput.value.trim();
            if (query) {
                appState.currentGenreId = null; // Clear genre filter
                appState.currentSearchQuery = query;
                
                // Hide all sections
                document.getElementById('upcoming-movies-section').style.display = 'none';
                document.getElementById('now-playing-movies-section').style.display = 'none';
                document.getElementById('popular-movies-section').style.display = 'none';
                document.getElementById('top-rated-movies-section').style.display = 'none';
                // Ensure this is also hidden
                const romanceMoviesSection = document.getElementById('romance-movies-section');
                if (romanceMoviesSection) {
                    romanceMoviesSection.style.display = 'none';
                }
                document.getElementById('airing-today-tv-section').style.display = 'none';
                document.getElementById('on-tv-section').style.display = 'none';
                document.getElementById('popular-tv-section').style.display = 'none';
                document.getElementById('top-rated-tv-section').style.display = 'none';

                // Load search results into the popular-movies-section (or popular-tv-section)
                const targetSectionId = appState.currentMediaType === 'movie' ? 'popular-movies-section' : 'popular-tv-section';
                document.getElementById(targetSectionId).style.display = 'block';
                genreButtonsContainer.classList.add('hidden'); // Hide genre buttons during search
                
                appState.pageCounters[targetSectionId.replace('-section', '')] = 1; // Reset page counter for the target search section
                loadMediaSection(appState.currentMediaType, targetSectionId.replace('-section', ''), 1, query); // Load search results into the appropriate grid
            } else {
                appState.currentSearchQuery = '';
                // If search input is empty, revert to showing all sections based on current media type
                if (appState.currentMediaType === 'movie') {
                    loadAllMovieSections();
                    genreButtonsContainer.classList.remove('hidden'); // Show genre buttons again for movies
                } else { // 'tv'
                    loadAllTvSections();
                    genreButtonsContainer.classList.remove('hidden'); // Show genre buttons again for TV
                }
            }
        }, 300); // 300ms debounce delay

        searchButton.addEventListener('click', debouncedSearch);
        searchInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                debouncedSearch();
            } else {
                // Trigger debounce on any keyup, not just Enter
                debouncedSearch();
            }
        });

        // Initial load when window loads
        window.onload = async () => {
            // Set current year in footer
            document.getElementById('current-year').textContent = new Date().getFullYear();
            
            // Set language to English by default (no selector)
            document.documentElement.lang = 'en'; // Set HTML lang attribute

            // Check if there's an existing hash
            if (!window.location.hash) {
                // If no hash, go to Layer 4 (Home SEO) by default
                window.location.hash = '#/home-seo';
            } else {
                // If there's an existing hash (e.g., direct link to a movie), handle it normally
                handleHashChange();
            }
        };

        // Add event listener for hash changes
        window.addEventListener('hashchange', handleHashChange);

        // Handle navigation buttons (Movies/TV Series)
        navHomeButton.addEventListener('click', () => { // New Home button event listener
            triggerAd(); // Trigger ad on Home button click
            window.location.hash = '#/home-seo'; // This will trigger handleHashChange to load Layer 4
        });

        navMoviesButton.addEventListener('click', () => {
            triggerAd(); // Trigger ad on Movies button click
            appState.currentSearchQuery = ''; // Clear search
            searchInput.value = ''; // Clear search input
            appState.currentGenreId = null; // Clear genre filter
            window.location.hash = '#/movies'; // Just set hash, handleHashChange will do the rest
        });

        navTvSeriesButton.addEventListener('click', () => {
            triggerAd(); // Trigger ad on TV Series button click
            appState.currentSearchQuery = ''; // Clear search
            searchInput.value = ''; // Clear search input
            appState.currentGenreId = null; // Clear genre filter
            window.location.hash = '#/tv'; // Just set hash, handleHashChange will do the rest
        });

        // Event listener for static movie cards in Layer 3 (UPDATED)
        // This event listener is no longer needed as the content is dynamic and handled by loadRomanceMoviesIntoStaticGrid
        // staticMovieGrid.addEventListener('click', (event) => {
        //     const clickedCard = event.target.closest('.static-movie-card');
        //     if (clickedCard) {
        //         const mediaId = clickedCard.dataset.mediaId;
        //         const mediaType = clickedCard.dataset.mediaType;
        //         const mediaTitle = clickedCard.querySelector('h3').textContent;
                
        //         if (mediaId && mediaType) {
        //             triggerAd(); // Trigger ad on static card click
        //             // Handle 'home' media type specifically
        //             if (mediaType === 'home') {
        //                 // If it's the 123Movies UK card, navigate to the home URL
        //                 window.location.href = 'https://123movies-uk.pages.dev/';
        //                 return; // Stop further processing for 'home' type
        //             }

        //             // Navigate to details for non-home media
        //             window.location.hash = `#/media/${mediaType}/${mediaId}/${slugify(mediaTitle)}`;
        //         }
        //     }
        // });

        // Function to load the SEO content into Layer 4
        function loadSeoContent() {
            const seoContentDiv = document.getElementById('seo-content');
            seoContentDiv.innerHTML = `
                <h1 class="text-indigo-400">Welcome to 123Movies UK: Your Ultimate Free Streaming Destination 🎬</h1>
                <img id="seo-banner-image" src="https://live.staticflickr.com/65535/54681957653_d6819848ed_b.jpg" alt="123Movies UK Banner" class="w-full h-auto object-cover mb-6 rounded-lg cursor-pointer">
                <p>In an era where entertainment is at our fingertips, finding a reliable and <strong class="text-green-400">free streaming platform</strong> can be a game-changer. Look no further than <strong>123Movies UK</strong>, your premier online destination for thousands of <strong class="text-green-400">free movies and TV series</strong>. We are dedicated to providing an unparalleled streaming experience, offering a vast library of content in <strong class="text-blue-400">high-definition quality</strong>, all without the need for subscriptions, hidden fees, or annoying sign-ups. Dive into the world of <strong class="text-purple-400">unlimited entertainment</strong> and discover why 123Movies UK is quickly becoming the go-to choice for viewers across the United Kingdom and beyond. Start <strong class="text-yellow-400">watching today</strong>!</p>

                <h2 class="text-blue-400">The Evolution of Free Online Streaming: Why 123Movies UK Stands Out ⭐</h2>
                <p>The landscape of online entertainment has evolved dramatically over the past decade. From traditional cable TV to paid streaming giants, consumers now have more choices than ever. However, the rising costs of multiple subscriptions can quickly add up, leaving many searching for viable, <strong class="text-green-400">free alternatives</strong>. This is where platforms like 123Movies UK step in, democratizing access to a world of cinematic and television content.</p>
                <h3 class="text-rose-400">Action & Adventure: Get Your Adrenaline Fix 💥</h3>
                <p>For those who crave excitement, our <strong class="text-rose-400">action and adventure</strong> categories are brimming with high-octane thrillers, epic quests, and superhero sagas. Experience explosive car chases, intense fight sequences, and breathtaking special effects, all from the comfort of your home. Discover titles that will keep you on the edge of your seat, from espionage thrillers to fantastical journeys.</p>
                <h3 class="text-yellow-400">Comedy: Laugh Out Loud 😂</h3>
                <p>Need a good laugh? Our <strong class="text-yellow-400">comedy</strong> section offers a wide array of films designed to lighten your mood. From witty romantic comedies to slapstick farces and dark satires, you'll find endless opportunities for amusement. Gather your friends and family for a night of shared laughter with our diverse comedic offerings.</p>
                <h3 class="text-indigo-400">Drama: Explore Human Emotions 🎭</h3>
                <p>Delve into the complexities of the human experience with our extensive <strong class="text-indigo-400">drama</strong> collection. These films offer compelling narratives, powerful performances, and often explore profound themes. Whether you prefer historical dramas, legal thrillers, or poignant character studies, our drama category provides rich storytelling that resonates deeply.</p>
                <h3 class="text-purple-400">Horror & Thriller: A Frighteningly Good Time 👻</h3>
                <p>If you enjoy a good scare or a suspenseful plot, our <strong class="text-purple-400">horror and thriller</strong> genres are perfect for you. From psychological thrillers that mess with your mind to supernatural horrors that make you jump, prepare for an unforgettable viewing experience. Our collection includes both modern masterpieces and cult classics that will keep you awake at night.</p>
                <h3 class="text-teal-400">Sci-Fi & Fantasy: Journey Beyond Imagination 🚀</h3>
                <p>Escape to other worlds and explore futuristic possibilities with our <strong class="text-teal-400">science fiction and fantasy</strong> films. Witness groundbreaking visual effects, innovative concepts, and imaginative storytelling. From dystopian futures to magical realms, these genres push the boundaries of creativity and offer truly immersive experiences.</p>
                <h3 class="text-pink-400">Romance: For the Heart ❤️</h3>
                <p>Indulge in heartwarming tales of love, passion, and relationships with our <strong class="text-pink-400">romance movie</strong> selection. Whether you prefer classic love stories, contemporary romantic comedies, or intense romantic dramas, our collection is designed to stir your emotions and leave you feeling uplifted.</p>

                <h2 class="text-green-400">Binge-Worthy TV Series: Endless Entertainment 📺</h2>
                <p>Beyond movies, 123Movies UK also boasts an impressive collection of <strong class="text-green-400">TV series</strong>, allowing you to binge-watch your favorite shows or discover new obsessions. Our TV series library includes:</p>
                <ul class="list-disc list-inside text-gray-300">
                    <li><strong>Popular Series:</strong> Catch up on the latest seasons of critically acclaimed shows and fan favorites.</li>
                    <li><strong>Classic TV:</strong> Revisit timeless sitcoms, dramas, and sci-fi series that have shaped television history.</li>
                    <li><strong>International Hits:</strong> Explore captivating series from around the globe, expanding your viewing horizons.</li>
                    <li><strong>Diverse Genres:</strong> From crime procedurals to fantasy epics, animated adventures to gripping documentaries, our TV series selection mirrors the diversity of our movie library.</li>
                </ul>
                <p>With new episodes and series added regularly, you'll never run out of engaging content to watch. Our platform makes it easy to track your progress and pick up exactly where you left off.</p>

                <h2 class="text-orange-400">Seamless Streaming Experience: Technology at Your Service ⚡</h2>
                <p>We understand that a great streaming experience goes beyond just content. That's why 123Movies UK is built on robust technology designed for <strong class="text-orange-400">seamless, uninterrupted viewing</strong>:</p>
                <ul class="list-disc list-inside text-gray-300">
                    <li><strong>Fast Loading Times:</strong> Minimize buffering and start watching your chosen title almost instantly.</li>
                    <li><strong>Adaptive Streaming:</strong> Our player adjusts video quality based on your internet connection, ensuring smooth playback even with varying bandwidth.</li>
                    <li><strong>Intuitive Player Controls:</strong> Easy-to-use controls for play, pause, volume, and full-screen mode enhance your viewing comfort.</li>
                    <li><strong>Regular Updates:</strong> Our technical team continuously works to improve the platform, fix bugs, and enhance performance, ensuring a cutting-edge streaming service.</li>
                </ul>

                <h2 class="text-cyan-400">Safety and Accessibility: Your Peace of Mind 🔒</h2>
                <p>Your safety and privacy are paramount at 123Movies UK. We strive to provide a <strong class="text-cyan-400">secure environment</strong> for your entertainment:</p>
                <ul class="list-disc list-inside text-gray-300">
                    <li><strong>No Registration Required:</strong> Enjoy content without the need to create an account, protecting your personal information.</li>
                    <li><strong>Minimal Ads:</strong> While we rely on ads to keep our service free, we aim to keep them as unobtrusive as possible, ensuring they don't significantly disrupt your viewing.</li>
                    <li><strong>Mobile-Friendly Design:</strong> Our website is fully responsive, adapting perfectly to any screen size, from smartphones to large desktop monitors. This means you can enjoy your favorite movies and shows on the go, anytime, anywhere.</li>
                </ul>

                <h2 class="text-lime-400">How to Get Started with 123Movies UK 🚀</h2>
                <p>Getting started with 123Movies UK is incredibly simple. Follow these easy steps to begin your <strong class="text-lime-400">free streaming journey</strong>:</p>
                <ol class="list-decimal list-inside text-gray-300">
                    <li><strong>Visit Our Website:</strong> Navigate to <a href="https://123movies-uk.pages.dev/" class="text-blue-400 hover:underline">123movies-uk.pages.dev</a> in your web browser.</li>
                    <li><strong>Browse or Search:</strong> Use our intuitive search bar to find specific titles or explore our categories and curated lists.</li>
                    <li><strong>Select Your Content:</strong> Click on the movie or TV series you wish to watch.</li>
                    <li><strong>Start Streaming:</strong> Choose a streaming server (Stream 1 or Stream 2) and enjoy your <strong class="text-lime-400">free entertainment</strong>!</li>
                </ol>
                <p>It's that easy! No complicated sign-ups, no credit card details, just pure, unadulterated entertainment.</p>

                <h2 class="text-fuchsia-400">Future of 123Movies UK 🌟</h2>
                <p>We are continuously working to expand our content library, improve streaming quality, and enhance the user experience. Our commitment is to remain a leading <strong class="text-fuchsia-400">free streaming platform</strong>, adapting to the evolving needs of our audience and the digital landscape. We value your feedback and are always looking for ways to make 123Movies UK even better.</p>

                <h2 class="text-red-400">Conclusion: Your Gateway to Free Entertainment 🍿</h2>
                <p>123Movies UK is more than just a streaming site; it's a gateway to a world of <strong class="text-red-400">free, high-quality entertainment</strong>. With an ever-growing collection of <strong class="text-red-400">movies and TV series</strong>, a user-friendly interface, and a commitment to seamless streaming, we invite you to explore our platform. Say goodbye to subscription fees and hello to <strong class="text-red-400">unlimited entertainment</strong>. Start watching today and experience the best of online streaming, completely free!</p>
            `;

            // Add event listener to the image after it's in the DOM
            const seoBannerImage = document.getElementById('seo-banner-image');
            if (seoBannerImage) {
                seoBannerImage.addEventListener('click', () => {
                    triggerAd(); // Trigger ad on SEO banner image click
                    // Subsequent clicks: navigate to Layer 1 (movies home)
                    window.location.hash = '#/movies'; // This will trigger handleHashChange to load movies
                });
            }
        }
    </script>
    <!-- Histats.com  START  (aync)-->
    <script type="text/javascript">var _Hasync= _Hasync|| [];
    _Hasync.push(['Histats.start', '1,4966360,4,0,0,0,00010000']);
    _Hasync.push(['Histats.fasi', '1']);
    _Hasync.push(['Histats.track_hits', '']);
    (function() {
    var hs = document.createElement('script'); hs.type = 'text/javascript'; hs.async = true;
    hs.src = ('//s10.histats.com/js15_as.js');
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(hs);
    })();</script>
    <noscript><a href="/" target="_blank"><img  src="//sstatic1.histats.com/0.gif?4966360&101" alt="hit counter code" border="0"></a></noscript>
    <!-- Histats.com  END  -->
</body>
</html>